---
output: pdf_document
header-includes:
    - \usepackage{pdfpages}
    - \usepackage[pages=some, placement = top, vshift = -100]{background}
    - \usepackage{tikz}
    - \usetikzlibrary{mindmap,shadows}
---
\backgroundsetup{scale=1,color=black,opacity=0.1,angle=0,contents={\includegraphics[width=4in,height=6in]{Baylor_grad}}}
\definecolor{BaylorGreen}{HTML}{003015}
\definecolor{LightBaylorGreen}{HTML}{005525}
\definecolor{DarkBaylorGreen}{HTML}{002510}
\definecolor{BaylorGold}{HTML}{fecb00}


```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(xtable.comment = FALSE)
```

```{r, include = FALSE}
inFile <- input$file
      inFile <- inFile[!(str_detect(inFile$name, ".docx")),]
      file.rename(inFile$datapath,
                  paste(inFile$datapath, ".xls", sep=""))
      files <- paste(inFile$datapath, ".xls", sep="") %>% 
        read_clean
      gathered <- files$crystal %>%
        gather("Variable", "Value", 16:26) %>%
        select(DEGR, MAJOR, `Year Term`, ID, YEAR, Variable, Value) %>%
        distinct %>%
        group_by(YEAR, DEGR, MAJOR)
      
      goBaylor <- files$goBaylor %>%
        gather("Go Baylor Code", "Count", 14:16) %>%
        select(BANNER_ID, APPLICATION_ID, PROGRAM, TERM, `Go Baylor Code`, Count) %>%
        distinct

      goBaylor <- goBaylor %>% mutate(YEAR = str_extract(TERM, "[0-9]{4}"))

      goBaylor %<>%
        group_by(YEAR, PROGRAM)
      
      
      maxYear <- if(gathered %>% 
                    filter(YEAR == max(YEAR)) %>% 
                    ungroup %>% 
                    select(`Year Term`) %>% 
                    str_detect(c("Spring", "Fall", "Summer")) %>% 
                    all()){
        max(gathered$YEAR)
      }else{
                       max(gathered$YEAR) - 1
                    }
      
      summaryApps <- gathered %>% 
        filter(YEAR == maxYear) %>% 
        group_by(Variable) %>% 
        summarise(Count = sum(Value, na.rm = TRUE))
      
      flowChartData <- data_frame(Total = summaryApps %>% 
                                    select(Count) %>% 
                                    sum,
                                  Offers = summaryApps %>% 
                                    filter(Variable %in% c("Regular Admission Extended", 
                                                           "Probationary Admission Extended")) %>%
                                    select(Count) %>%
                                    sum,
                                  Rejected = summaryApps %>% 
                                    filter(Variable == "Rejected") %>%
                                    select(Count) %>% 
                                    sum,
                                  Enrolled = summaryApps %>% 
                                    filter(Variable %in% c("Regular Admission Accepted", 
                                                           "Probationary Admission Accepted")) %>%
                                    select(Count) %>%
                                    sum,
                                  Declined = summaryApps %>% 
                                    filter(Variable %in% c("Regular Admission Declined", 
                                                           "Probationary Admission Declined")) %>%
                                    select(Count) %>%
                                    sum) %>%
        mutate(OffersPer = round(Offers / Total * 100),
               RejectedPer = round(Rejected / Total * 100),
               EnrolledPer = round(Enrolled / Offers * 100),
               DeclinedPer = round(Declined / Offers * 100))
      
```

\BgThispage

\textbf{\Huge\begin{center}
Graduate School Report
\end{center}
\LARGE\begin{center}
Admissions and Recruiting
\end{center}}
\vspace{2in}

\begin{figure}[h]
\begin{tikzpicture}[every annotation/.style = {draw, fill = white, font = \Large,}]
                     
  \path[mindmap,
        text = white,
        every node/.style = {concept, circular drop shadow},
        root/.style = {concept color = BaylorGreen,
                       font =\bfseries,
                       text width = 9em},
        level 1 concept/.append style = {font = \bfseries, 
                                         sibling angle = 40, 
                                         text width = 8em, 
                                         level distance = 20em},
        level 2 concept/.append style = {font = \bfseries,
                                         text width = 7em,
                                         level distance = 20em, 
                                         sibling angle = 35}]
    
  node[root] {`r flowChartData$Total` \\ Applications \\ in `r maxYear` \\ Calendar Year} [clockwise from=20]
    child[concept color = BaylorGreen!50!BaylorGold] {
      node {`r flowChartData$Offers` Offers \\ (`r flowChartData$OffersPer` \% \\ Acceptance \\ rate)} [clockwise from=10]
        child[concept color = BaylorGold] { node {`r flowChartData$Enrolled` \\ Enrolled \\ (`r flowChartData$EnrolledPer`\% yield)}} 
        child[concept color = BaylorGold] { node {`r flowChartData$Declined` \\ Declined \\ (`r flowChartData$DeclinedPer`\%)}} 
    }
    child[concept color=BaylorGreen!50!BaylorGold] {
      node[concept] {`r flowChartData$Rejected` \\ Rejected \\ (`r flowChartData$RejectedPer`\%)}
      };
\end{tikzpicture}
\end{figure}

\clearpage

\newpage
# Graduate School Numbers
```{r, child = 'applications.Rmd'}
```

```{r, child = 'offerRejectionCancelled.Rmd'}
```

```{r, child = 'acceptedDeclined.Rmd'}
```

```{r, child = 'GoBaylor.Rmd'}
```


